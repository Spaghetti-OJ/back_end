# 開發日誌 - 2025-11-09

## 日期與開發者
- **日期**: 2025年11月9日
- **分支**: `chore/move-editorial-API`
- **開發階段**: Submission Model 擴展與一致性修復

---

## 工作概要

今天的主要工作包含兩個重要部分：1) 為 Submission 模型添加新功能以支援 NOJ 兼容性，2) 修復 Copilot 發現的 serializer 一致性問題。工作涉及資料庫模型更新、狀態編碼標準化、以及 serializer 邏輯優化。

### 開發統計
- **Migration 文件**: 2 個新增
- **Model 欄位**: 1 個新增 (`is_custom_test`)  
- **狀態編碼**: 10 個標準化狀態
- **測試通過率**: 69/69 (100%)
- **一致性問題**: 3 個修復

---

## 主要開發任務

### 1. Submission Model 擴展

#### 1.1 新增 is_custom_test 欄位
```python
# 在 Submission model 中添加
is_custom_test = models.BooleanField(default=False)  # 標記是否為自訂測試
```

**目的**: 區分正式提交和自訂測試提交，支援不同的處理邏輯。

#### 1.2 狀態編碼標準化
```python
# 舊的狀態系統
STATUS_CHOICES = [
    ('pending', 'Pending'),
    ('accepted', 'Accepted'),
    ('wrong_answer', 'Wrong Answer'),
    # ...
]

# 新的 NOJ 兼容狀態系統
STATUS_CHOICES = [
    ('-2', 'No Code'),              # 兼容舊的 NOJ，還沒有 code 的 submission
    ('-1', 'Pending'),              # 等待判題
    ('0', 'Accepted'),              # AC - 答案正確
    ('1', 'Wrong Answer'),          # WA - 答案錯誤
    ('2', 'Compilation Error'),     # CE - 編譯錯誤
    ('3', 'Time Limit Exceeded'),   # TLE - 超過時間限制
    ('4', 'Memory Limit Exceeded'), # MLE - 超過記憶體限制
    ('5', 'Runtime Error'),         # RE - 執行時錯誤
    ('6', 'Judge Error'),           # JE - 判題系統錯誤
    ('7', 'Output Limit Exceeded'), # OLE - 輸出超過限制
]
```

**改進點**:
- 採用數字編碼，與標準 OJ 系統兼容
- 支援 `-2` 狀態以兼容舊的 NOJ 系統
- 涵蓋完整的判題結果狀態

#### 1.3 更新相關邏輯
```python
# 更新 is_judged 屬性
@property
def is_judged(self):
    """檢查是否已經判題完成"""
    return self.status not in ['-2', '-1']  # No Code 和 Pending 表示尚未判題
```

### 2. Database Migration

#### 2.1 自動生成 Migration
```bash
python manage.py makemigrations submissions
```

**生成結果**:
- `0003_submission_is_custom_test_alter_submission_status.py`: 初始 migration
- `0004_alter_submission_status.py`: 狀態選項更新

#### 2.2 Migration 內容
```python
operations = [
    migrations.AddField(
        model_name='submission',
        name='is_custom_test',
        field=models.BooleanField(default=False),
    ),
    migrations.AlterField(
        model_name='submission',
        name='status',
        field=models.CharField(
            choices=[('-2', 'No Code'), ('-1', 'Pending'), ('0', 'Accepted'), ...],
            default='-1',  # 更新預設值為 Pending
            max_length=30
        ),
    ),
]
```

### 3. Serializer 更新

#### 3.1 SubmissionSerializer 調整
```python
class SubmissionSerializer(serializers.ModelSerializer):
    class Meta:
        model = Submission
        fields = '__all__'
        read_only_fields = [
            'id', 'code_hash', 'status', 'score', 'execution_time',
            'memory_usage', 'judged_at', 'created_at', 'is_custom_test'  # 新增
        ]
```

### 4. 一致性問題修復

#### 4.1 Editorial Content 驗證邏輯
**問題**: 驗證 stripped 版本，但儲存 unstripped 版本

```python
# 修復前
def validate_content(self, value):
    if not value.strip():
        raise ValidationError('內容不能只包含空白字元')
    return value.strip()  # 不一致！

# 修復後
def validate_content(self, value):
    if not value.strip():
        raise ValidationError('內容不能只包含空白字元')
    return value  # 保持原始內容，允許格式空白
```

**設計原則**:
- **Title**: 自動 strip，標題不需要前後空白
- **Content**: 保持原樣，允許格式空白（縮排、換行等）

#### 4.2 CustomTest trim_whitespace 一致性
**問題**: source_code 與 input_data/expected_output 處理方式不一致

```python
# 修復前
source_code = serializers.CharField(...)  # 預設 trim_whitespace=True
input_data = serializers.CharField(trim_whitespace=False)

# 修復後
source_code = serializers.CharField(trim_whitespace=False)  # 統一設定
input_data = serializers.CharField(trim_whitespace=False)
```

**原因**: 程式碼和測試資料的空白可能具有重要意義，應該統一保持原樣。

### 5. 測試更新

#### 5.1 狀態測試更新
```python
# 更新 Hypothesis 測試使用新的狀態編碼
@given(
    status=st.sampled_from(['-2', '-1', '0', '1', '2', '3', '4', '5'])
)
def test_submission_is_judged_property(self, status):
    # 根據新的狀態編碼：-2=No Code, -1=Pending 表示尚未判題
    expected_is_judged = status not in ['-2', '-1']
    assert submission.is_judged == expected_is_judged
```

#### 5.2 Redis Cache 測試更新
```python
# 更新快取鍵測試的狀態選項
@given(
    status=st.sampled_from(['-2', '-1', '0', '1', '2', '3', None]),
    # ...
)
```

#### 5.3 Editorial 測試期望值修正
```python
# 更新測試期望以匹配新的驗證行為
assert editorial.title == title.strip()  # title 會被 strip
assert editorial.content == content      # content 保持原樣
```

---

## 技術挑戰與解決方案

### 1. 狀態編碼兼容性
**挑戰**: 需要同時支援新的數字編碼和舊系統的兼容性

**解決方案**:
- 使用字串格式存儲數字編碼 (`'-2'`, `'0'`, `'1'` 等)
- 保持 Django CharField 的靈活性
- 添加 `-2` 狀態專門用於舊 NOJ 系統兼容

### 2. Hypothesis 測試隨機性
**挑戰**: Hypothesis 生成包含 null 字符的測試數據導致驗證失敗

**解決方案**:
```python
# 過濾掉包含 null 字符的測試數據
source_code=st.text(min_size=1, max_size=500).filter(lambda x: x.strip() and '\x00' not in x)
```

### 3. Serializer 一致性
**挑戰**: 不同欄位對空白字符的處理方式不統一

**解決方案**:
- 建立明確的設計原則
- 統一相關欄位的 `trim_whitespace` 設定
- 更新測試期望值以匹配新行為

---

## 程式碼品質改進

### 1. 註解更新
```python
# 更新狀態選項註解，提供清晰的說明
STATUS_CHOICES = [
    ('-2', 'No Code'),              # 兼容舊的 NOJ，還沒有 code 的 submission
    ('-1', 'Pending'),              # 等待判題
    ('0', 'Accepted'),              # AC - 答案正確
    # ...
]
```

### 2. 方法文檔
```python
@property
def is_judged(self):
    """檢查是否已經判題完成"""
    return self.status not in ['-2', '-1']  # No Code 和 Pending 表示尚未判題
```

### 3. 一致性原則
- **Editorial Title**: 自動標準化（strip）
- **Editorial Content**: 保持格式完整性
- **CustomTest 欄位**: 統一保持原始格式

---

## 測試驗證結果

### 最終測試執行
```bash
python manage.py test submissions.test_file -v 0
```

**結果**:
- 總測試數: 69
- 通過: 69  
- 失敗: 0
- 錯誤: 0
- 執行時間: 18.599 秒
- 通過率: 100%

### 特定測試驗證
```bash
# Editorial API 測試
python manage.py test submissions.test_file.test_editorial_api -v 2
# 結果: 15/15 通過

# Serializer 測試
python manage.py test submissions.test_file.test_serializers -v 2
# 結果: 完整通過，包括修復的一致性問題
```

---

## 影響分析

### 1. 資料庫影響
- **新欄位**: `is_custom_test` boolean，預設 False
- **狀態更新**: 從文字狀態改為數字編碼字串
- **向後兼容**: 支援 `-2` 狀態以兼容舊系統

### 2. API 影響
- **Submission API**: 新增 `is_custom_test` 欄位（只讀）
- **狀態值**: API 回傳的狀態將使用數字編碼
- **驗證邏輯**: Editorial 和 CustomTest 的空白處理更一致

### 3. 系統整合
- **判題系統**: 可根據 `is_custom_test` 欄位進行不同處理
- **NOJ 兼容**: 支援 `-2` 狀態的舊系統整合
- **快取系統**: Redis 快取鍵支援新的狀態編碼

## 總結

今天的開發工作成功完成了兩個重要目標：

1. **功能擴展**: 為 Submission 系統添加了 `is_custom_test` 欄位和標準化的狀態編碼，提升了系統的兼容性和可擴展性。

2. **品質改進**: 修復了 Copilot 發現的 serializer 一致性問題，提升了代碼品質和邏輯一致性。

所有變更都經過完整的測試驗證，確保了系統的穩定性和功能完整性。新的狀態編碼系統為後續與其他 OJ 系統的整合奠定了良好基礎。