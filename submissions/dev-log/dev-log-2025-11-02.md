# 開發日誌 - 2025年11月2日

## 今日開發總結

### 主要完成
- 完成題解 API 的四個核心端點實現和測試
- 修復 UUID 驗證和問題存在性檢查的錯誤處理
- 優化需求：移除過度嚴格的內容和難度評級限制
- 建立完整的 API 文檔和測試框架
- 實現端到端的 curl 測試驗證


---

## 開發過程：問題發現與解決

### 問題1: 無效UUID返回HTML 404而非JSON錯誤

**發現問題**
```bash
# 測試無效UUID格式時
curl -X PUT http://127.0.0.1:8000/submissions/problem/1/solution/invalid-uuid/ \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"title": "test", "content": "test content"}'

# 結果返回：HTML 404頁面而不是JSON錯誤
<!DOCTYPE html>
<html lang="en">
<head>
  <title>Page not found at /submissions/problem/1/solution/invalid-uuid/</title>
```

**分析問題**
- Django的URL路由在UUID格式驗證失敗時直接返回404
- 沒有到達我們的view處理邏輯
- 前端無法正確解析HTML響應

**解決方案**
```python
# 在 EditorialDetailView.get_object() 中添加UUID驗證
def get_object(self):
    problem_id = self.kwargs['problem_id']
    solution_id = self.kwargs['solution_id']
    
    # 驗證UUID格式
    try:
        uuid.UUID(str(solution_id))
    except (ValueError, TypeError):
        raise ValidationError("無效的題解ID格式")
    
    # 檢查問題是否存在
    try:
        Problems.objects.get(id=problem_id)
    except Problems.DoesNotExist:
        raise NotFound("問題不存在")
    
    obj = get_object_or_404(Editorial, id=solution_id, problem_id=problem_id)
    return obj
```

**驗證結果**
- 無效UUID現在返回400 JSON錯誤：`{"error": "無效的題解ID格式"}`
- 錯誤處理統一且對前端友好

---

### 問題2: 無效問題ID返回空數組而非404錯誤

**發現問題**
```bash
# 測試不存在的問題ID
curl -X GET http://127.0.0.1:8000/submissions/problem/999/solution/ \
  -H "Authorization: Bearer $TOKEN"

# 結果：返回空數組 [] 而不是404錯誤
[]
```

**分析問題**
- `get_queryset()` 只是過濾，不會檢查問題是否存在
- 即使問題不存在，空的queryset也是有效的
- 體驗不佳：無法區分「問題存在但沒有題解」vs「問題不存在」

**解決方案**
```python
# 在 EditorialListCreateView.get_queryset() 中添加問題存在性檢查
def get_queryset(self):
    problem_id = self.kwargs['problem_id']
    
    # 檢查問題是否存在
    try:
        Problems.objects.get(id=problem_id)
    except Problems.DoesNotExist:
        raise NotFound("問題不存在")
        
    return Editorial.objects.filter(
        problem_id=problem_id,
        status='published'
    ).order_by('-is_official', '-likes_count', '-created_at')
```

**驗證結果**
- 無效問題ID現在返回404 JSON錯誤：`{"detail": "問題不存在"}`
- 邏輯更清晰，錯誤訊息明確

---

---

### 問題3: 按讚功能的錯誤處理不一致

**發現問題**
在按讚功能測試中發現錯誤處理不統一：
- 有些地方返回 `get_object_or_404` 的HTML錯誤
- 沒有統一的UUID和問題存在性檢查

**分析問題**
- `editorial_like_toggle` 函數沒有統一的錯誤處理
- 缺少UUID格式驗證
- 錯誤響應格式不一致

**解決方案**
```python
@api_view(['POST', 'DELETE'])
@permission_classes([permissions.IsAuthenticated])
def editorial_like_toggle(request, problem_id, solution_id):
    """題解按讚/取消按讚"""
    
    # 驗證UUID格式
    try:
        uuid.UUID(str(solution_id))
    except (ValueError, TypeError):
        return Response(
            {'error': '無效的題解ID格式'},
            status=status.HTTP_400_BAD_REQUEST
        )
    
    # 檢查問題是否存在
    try:
        Problems.objects.get(id=problem_id)
    except Problems.DoesNotExist:
        return Response(
            {'error': '問題不存在'},
            status=status.HTTP_404_NOT_FOUND
        )
    
    # 其餘邏輯...
```

**驗證結果**
- 所有API端點的錯誤處理現在統一
- JSON格式錯誤響應，便於前端處理

---

## 測試結果驗證

### 自動化測試腳本執行結果

```bash
=== 題解API測試腳本 ===
基礎URL: http://127.0.0.1:8000
測試問題ID: 1

步驟1: 獲取認證令牌 
- 成功獲取JWT access token

步驟2: 發布題解 (POST) 
- 成功創建題解 ID: fefbcf77-2df6-40aa-aa39-587b7c3b30c0
- 響應包含完整字段：title, content, difficulty_rating, is_official

步驟3: 獲取題解列表 (GET)  
- 正確返回題解數組
- 排序符合預期：官方題解優先

步驟4: 修改題解 (PUT) 
- 成功更新標題和內容
- difficulty_rating 正確更新為 4.0

步驟5: 刪除題解 (DELETE) 
- 返回 HTTP 204 No Content
- 符合 REST 標準

步驟6: 錯誤情況測試 
- 無效問題ID: 返回空數組 → 已修復為404錯誤
- 無效UUID: 返回HTML → 已修復為JSON錯誤  
- 無認證請求: 正確返回401
- 數據驗證: 正確返回400錯誤
```

### 核心功能驗證

| 功能 | 狀態 | 測試結果 |
|------|------|----------|
| JWT認證 | O | 令牌獲取和驗證正常 |
| 權限控制 | O| 只有課程老師/TA可管理題解 |
| CRUD操作 | O| 創建、讀取、更新、刪除全部正常 |
| 數據驗證 | O| 內容不為空、標題長度等驗證生效 |
| 錯誤處理 | O| 統一JSON錯誤響應格式 |
| 排序邏輯 | O| 官方題解→按讚數→創建時間 |

---

## 文檔和交付物

### 創建的文件

1. **API文檔** (`/docs/submissions.MD`)
   - 四個核心API的完整說明
   - 請求/響應格式範例
   - 錯誤碼和處理說明
   - 權限和使用注意事項

2. **測試報告** (`/submissions/test_logs/editorial_api_test_report.md`)
   - 詳細測試結果分析
   - 問題發現和修復記錄
   - 性能表現評估
   - 部署準備度評估

3. **自動化測試腳本** (`/submissions/test_logs/test_editorial_api.sh`)
   - 完整的端到端測試
   - 自動化錯誤情況測試
   - 彩色輸出和詳細說明

### API端點總結

| 端點 | 方法 | 功能 | 狀態 |
|------|------|------|------|
| `/problem/{id}/solution/` | POST | 發布題解 | 完成 |
| `/problem/{id}/solution/` | GET | 獲取題解列表 | 完成 |
| `/problem/{id}/solution/{uuid}/` | PUT | 修改題解 | 完成 |
| `/problem/{id}/solution/{uuid}/` | DELETE | 刪除題解 | 完成 |
| `/problem/{id}/solution/{uuid}/like/` | POST/DELETE | 按讚功能 | 額外功能 |

---

## 學習
1. **錯誤處理設計**: 學會在Django中統一API錯誤響應格式
2. **UUID驗證**: 理解Django URL路由和自定義驗證的配合
3. **序列化器設計**: 掌握同一序列化器用於創建和更新的最佳實踐
4. **權限控制**: 實現基於課程成員關係的複雜權限邏輯

