name: Deploy to dev

on:
  push:
    branches:
      - dev
      - chore/deploy-workflow

concurrency: deploy-dev

env:
  # 改用 runner 家目錄（絕對路徑），避免巢狀與 sudo
  APP_DIR: ${{ runner.home }}/back_end_deploy
  VENV_PATH: ${{ runner.home }}/back_end_deploy/.venv
  PYTHONUNBUFFERED: "1"

jobs:
  deploy:
    runs-on: self-hosted            # 需要在要部署的機器上安裝 self-hosted runner

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Ensure app directory exists
        run: |
          mkdir -p "${APP_DIR}"

      - name: Ensure venv exists
        run: |
          if [ ! -f "${VENV_PATH}/bin/activate" ]; then
            rm -rf "${VENV_PATH}"
            python3 -m venv "${VENV_PATH}"
          fi

      - name: Sync repository to target directory
        run: |
          rsync -a --delete --exclude '.git' --exclude '.venv' ./ "${APP_DIR}/"

      - name: Install dependencies
        run: |
          cd "${APP_DIR}"
          source "${VENV_PATH}/bin/activate"
          pip install -r requirements.txt

      - name: Reset migrations
        run: |
          cd "${APP_DIR}"
          source "${VENV_PATH}/bin/activate"
          bash reset_migrations.sh

      - name: Make and apply migrations
        run: |
          cd "${APP_DIR}"
          source "${VENV_PATH}/bin/activate"
          python manage.py makemigrations
          python manage.py migrate --noinput

      - name: Collect static files
        run: |
          cd "${APP_DIR}"
          source "${VENV_PATH}/bin/activate"
          python manage.py collectstatic --noinput

      - name: Restart application (dev runserver)
        run: |
          cd "${APP_DIR}"
          source "${VENV_PATH}/bin/activate"
          # 停掉先前的 runserver（如果有）
          pkill -f "manage.py runserver" || true
          # 背景啟動 runserver；依需求調整 host/port
          nohup python manage.py runserver 0.0.0.0:8000 --noreload --insecure >/tmp/django.log 2>&1 &
