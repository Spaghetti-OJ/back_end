name: Deploy to dev

on:
  push:
    branches:
      - dev
      - chore/deploy-workflow

concurrency: deploy-dev

env:
  PYTHONUNBUFFERED: "1"

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set deploy paths
        run: |
          echo "APP_DIR=$HOME/back_end_deploy" >> "$GITHUB_ENV"
          echo "VENV_PATH=$HOME/back_end_deploy/.venv" >> "$GITHUB_ENV"

      - name: Ensure app directory exists
        run: |
          mkdir -p "${APP_DIR}"

      - name: Ensure venv exists
        run: |
          if [ ! -f "${VENV_PATH}/bin/activate" ]; then
            rm -rf "${VENV_PATH}"
            python3 -m venv "${VENV_PATH}"
          fi

      - name: Sync repository to target directory
        run: |
          rsync -a --delete --exclude '.git' --exclude '.venv' ./ "${APP_DIR}/"

      - name: Install dependencies
        run: |
          cd "${APP_DIR}"
          source "${VENV_PATH}/bin/activate"
          pip install -r requirements.txt

      - name: Reset migrations
        run: |
          cd "${APP_DIR}"
          source "${VENV_PATH}/bin/activate"
          # 避免在 runtime 備份資料夾上遞迴刪檔
          rm -rf backups || true
          bash reset_migrations.sh

      - name: Make and apply migrations
        run: |
          cd "${APP_DIR}"
          source "${VENV_PATH}/bin/activate"
          python manage.py makemigrations
          python manage.py migrate --noinput

      # - name: Collect static files
      #   run: |
      #     cd "${APP_DIR}"
      #     source "${VENV_PATH}/bin/activate"
      #     python manage.py collectstatic --noinput

      - name: Restart application (dev runserver)
        run: |
          # 只需要一行指令重啟服務，Systemd 會負責在背景跑
          sudo systemctl restart django-dev
      
      - name: Create superuser
        env:
          DJANGO_SUPERUSER_USERNAME: test
          DJANGO_SUPERUSER_PASSWORD: "abc12345"
          DJANGO_SUPERUSER_EMAIL: test@gmail.com
        run: |
          cd "${APP_DIR}"
          source "${VENV_PATH}/bin/activate"
          python manage.py createsuperuser --noinput || true
