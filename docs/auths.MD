# å¾Œç«¯ API èªªæ˜ï¼ˆæä¾›çµ¦å‰ç«¯ï¼‰

æœ¬å°ˆæ¡ˆå¾Œç«¯ä½¿ç”¨ **Django + Django REST Framework**ã€‚

## âš ï¸ å…¨åŸŸå›æ‡‰æ ¼å¼ (Global Response Format)

ç‚ºäº†çµ±ä¸€å‰å¾Œç«¯æºé€šï¼Œ**æ‰€æœ‰ API**ï¼ˆç„¡è«–æˆåŠŸæˆ–å¤±æ•—ï¼‰çš„å›æ‡‰ JSON éƒ½æœƒéµå¾ªä»¥ä¸‹çµæ§‹ï¼š

```json
{
  "data": <å¯¦éš›è³‡æ–™ Payload (Object æˆ– Array)>,
  "message": "çµ¦ä½¿ç”¨è€…çœ‹çš„æ“ä½œè¨Šæ¯ (ä¾‹å¦‚ï¼šå»ºç«‹æˆåŠŸ)",
  "status": "ok" | "error"
}
```

  * **æˆåŠŸ (2xx)**ï¼š`status` ç‚º `"ok"`ï¼Œ`data` åŒ…å«è«‹æ±‚çš„è³‡æºã€‚
  * **å¤±æ•— (4xx/5xx)**ï¼š`status` ç‚º `"error"`ï¼Œ`message` åŒ…å«éŒ¯èª¤åŸå› ï¼Œ`data` å¯èƒ½åŒ…å«è©³ç´°æ¬„ä½éŒ¯èª¤è³‡è¨Šã€‚

-----

## ğŸ” èªè­‰æ©Ÿåˆ¶ (Authentication)

æœ¬ç³»çµ±æ”¯æ´å…©ç¨®èªè­‰æ–¹å¼ï¼Œå‰ç«¯å¯è¦–æƒ…å¢ƒé¸æ“‡ï¼š

### 1\. Session èªè­‰ (ç€è¦½å™¨/å‰ç«¯ Web)

  * **é©ç”¨å°è±¡**ï¼šä¸€èˆ¬ä½¿ç”¨è€…åœ¨ç€è¦½å™¨æ“ä½œã€‚
  * **æ©Ÿåˆ¶**ï¼šç™»å…¥å¾Œå–å¾— `sessionid` Cookieã€‚
  * **CSRF ä¿è­·**ï¼šæ‰€æœ‰ **POST/PUT/DELETE** è«‹æ±‚å¿…é ˆåœ¨ Header é™„å¸¶ `X-CSRFToken`ã€‚
      * å€¼è«‹å¾ `csrftoken` Cookie è®€å–ã€‚

### 2\. API Token èªè­‰ (è…³æœ¬/ç¬¬ä¸‰æ–¹å·¥å…·)

  * **é©ç”¨å°è±¡**ï¼šCLI å·¥å…·ã€CI/CDã€è‡ªå‹•åŒ–è…³æœ¬ã€‚
  * **æ©Ÿåˆ¶**ï¼šåœ¨ HTTP Header ä¸­å¸¶å…¥ Tokenã€‚
  * **Header æ ¼å¼**ï¼š
    ```
    Authorization: Bearer noj_pat_xxxxxxxx...
    ```
    *(æ³¨æ„ï¼š`Bearer` å¾Œé¢æœ‰ä¸€å€‹ç©ºæ ¼)*

-----

## 1\. API Tokens (ç®¡ç† API é‡‘é‘°)

**åŸºç¤è·¯å¾‘**ï¼š`/api-tokens/`

### 1.1 åˆ—å‡º API Tokens

**è·¯å¾‘**ï¼š`GET /api-tokens/`
**æ¬Šé™**ï¼šç™»å…¥ä½¿ç”¨è€…ã€‚

**æˆåŠŸå›æ‡‰ (200 OK)**ï¼š

```json
{
    "data": [
        {
            "id": "a1b2c3d4-...",
            "name": "æˆ‘çš„ç­†é›» CLI Token",
            "prefix": "noj_pat_aBcD", 
            "permissions": ["read:user", "read:problems"],
            "usage_count": 42,
            "last_used_at": "2025-10-18T10:30:00Z",
            "last_used_ip": "192.168.1.100",
            "created_at": "2025-10-10T08:00:00Z",
            "expires_at": null,
            "is_active": true,
            "is_expired": false
        }
    ],
    "message": "æˆåŠŸå–å¾— Token åˆ—è¡¨",
    "status": "ok"
}
```

### 1.2 å»ºç«‹ API Token

**è·¯å¾‘**ï¼š`POST /api-tokens/`
**æ¬Šé™**ï¼šç™»å…¥ä½¿ç”¨è€…ã€‚

**è«‹æ±‚ Body**ï¼š

```json
{
    "name": "æˆ‘çš„æ¸¬è©¦ Token", 
    "permissions": ["read:user"],  // (é¸å¡«) é™åˆ¶æ¬Šé™ç¯„åœ
    "expires_at": "2026-12-31T23:59:59Z" // (é¸å¡«)
}
```

**æˆåŠŸå›æ‡‰ (201 Created)**ï¼š
âš ï¸ **æ³¨æ„**ï¼š`full_token` åªæœƒé¡¯ç¤ºé€™ä¸€æ¬¡ï¼Œè«‹æç¤ºä½¿ç”¨è€…ç«‹åˆ»å„²å­˜ã€‚

```json
{
    "data": {
        "full_token": "noj_pat_aBcDeFgHiJkLmNoPqRsTuvWxyZ1234567890abcdef"
    },
    "message": "API Token å·²å»ºç«‹ï¼Œè«‹å¦¥å–„ä¿å­˜",
    "status": "ok"
}
```

### 1.3 åˆªé™¤ API Token

**è·¯å¾‘**ï¼š`DELETE /api-tokens/<uuid:id>/`
**æ¬Šé™**ï¼šç™»å…¥ä½¿ç”¨è€… (åªèƒ½åˆªé™¤è‡ªå·±çš„)ã€‚

**æˆåŠŸå›æ‡‰ (200 OK)**ï¼š

```json
{
    "data": {},
    "message": "Token å·²æˆåŠŸåˆªé™¤",
    "status": "ok"
}
```

-----

## 2\. Auths (æ—¥èªŒèˆ‡æ´»å‹•)

**åŸºç¤è·¯å¾‘**ï¼š`/auth/`

### 2.1 å–å¾—å€‹äººç™»å…¥æ—¥èªŒ

**è·¯å¾‘**ï¼š`GET /auth/login-logs/`
**æ¬Šé™**ï¼šç™»å…¥ä½¿ç”¨è€… (æŸ¥çœ‹è‡ªå·±çš„)ã€‚

**å›æ‡‰ç¯„ä¾‹**ï¼š

```json
{
    "data": [
        {
            "id": 1,
            "login_status": "æˆåŠŸ",
            "ip_address": "127.0.0.1",
            "user_agent": "Mozilla/5.0 ...",
            "created_at": "2025-11-25T12:00:00Z"
        }
    ],
    "message": "æˆåŠŸå–å¾—ä½¿ç”¨è€…ç™»å…¥æ—¥èªŒ",
    "status": "ok"
}
```

### 2.2 ç´€éŒ„ä½¿ç”¨è€…æ´»å‹• (Frontend Tracking)

**è·¯å¾‘**ï¼š`POST /auth/activity/`
**æ¬Šé™**ï¼šç™»å…¥ä½¿ç”¨è€…ã€‚
**ç”¨é€”**ï¼šå‰ç«¯å¯ä»¥ç”¨æ­¤ API è¨˜éŒ„ä½¿ç”¨è€…çš„è¡Œç‚º (ä¾‹å¦‚ï¼šé€²å…¥é¡Œç›®é é¢ã€é»æ“Šä¸‹è¼‰)ã€‚

**è«‹æ±‚ Body**ï¼š

```json
{
    "activity_type": "view_problem", // å¿…å¡«ï¼Œé ˆç¬¦åˆå¾Œç«¯å®šç¾©
    "description": "User viewed Problem 101",
    "metadata": { "problem_id": 101 }
}
```

**æˆåŠŸå›æ‡‰ (201 Created)**ï¼š

```json
{
    "data": { ...æ–°å»ºç«‹çš„æ´»å‹•ç‰©ä»¶... },
    "message": "æ´»å‹•è¨˜éŒ„æˆåŠŸ",
    "status": "ok"
}
```

-----

## 3\. ç®¡ç†å“¡å°ˆç”¨ API (Admin Only)

**æ¬Šé™**ï¼šåƒ…é™ç®¡ç†å“¡ (`is_staff=True`)ã€‚ä¸€èˆ¬ä½¿ç”¨è€…å‘¼å«æœƒæ”¶åˆ° 403 Forbiddenã€‚

### 3.1 æŸ¥çœ‹ç‰¹å®šä½¿ç”¨è€…çš„ç™»å…¥æ—¥èªŒ

**è·¯å¾‘**ï¼š`GET /auth/login-logs/<uuid:user_id>/`

### 3.2 æŸ¥çœ‹ç‰¹å®šä½¿ç”¨è€…çš„æ´»å‹•ç´€éŒ„

**è·¯å¾‘**ï¼š`GET /auth/activity/<uuid:user_id>/`

### 3.3 æŸ¥çœ‹ç•°å¸¸ç™»å…¥æ´»å‹• (Suspicious)

**è·¯å¾‘**ï¼š`GET /auth/suspicious-activities/`
**ç”¨é€”**ï¼šåˆ—å‡ºæ‰€æœ‰ç™»å…¥å¤±æ•— (å¯†ç¢¼éŒ¯èª¤ã€å¸³è™Ÿä¸å­˜åœ¨) çš„ç´€éŒ„ï¼Œç”¨æ–¼è³‡å®‰å¯©è¨ˆã€‚
**æ¬Šé™**ï¼šåƒ…é™ç®¡ç†å“¡ã€‚

**æŸ¥è©¢åƒæ•¸ (Query Params)**ï¼š
* `page` (int, é¸å¡«)ï¼šé ç¢¼ï¼Œé è¨­ç‚º 1ã€‚

**æˆåŠŸå›æ‡‰ (200 OK) - å«åˆ†é è³‡è¨Š**ï¼š
```json
{
  "data": {
    "count": 42,
    "next": "http://.../?page=2",
    "previous": null,
    "results": [
      {
        "id": 123,
        "username": "hacker",
        "login_status": "failed_credentials",
        "ip_address": "192.168.1.100",
        "created_at": "2025-11-28T12:00:00Z"
      }
    ]
  },
  "message": "æˆåŠŸå–å¾—ç•°å¸¸ç™»å…¥ç´€éŒ„åˆ—è¡¨",
  "status": "ok"
}

## 4\. æŠ„è¥²æª¢æ¸¬ (Copycat - MOSS)

**åŸºç¤è·¯å¾‘**ï¼š`/copycat/`

> **æ¬Šé™èªªæ˜**ï¼šæ­¤æ¨¡çµ„åƒ…é™ **ç®¡ç†å“¡ (Admin, `is_staff=True`)** ä½¿ç”¨ã€‚ä¸€èˆ¬ä½¿ç”¨è€…å‘¼å«æœƒæ”¶åˆ° `403 Forbidden`ã€‚
> **é©—è­‰æ–¹å¼**ï¼šä½¿ç”¨ Session Cookieã€‚**POST è«‹æ±‚å‹™å¿…é™„å¸¶ `X-CSRFToken` Headerã€‚**

### 4.1 è«‹æ±‚ç”Ÿæˆæª¢æ¸¬å ±å‘Š (Trigger)

**è·¯å¾‘**ï¼š`POST /copycat/`
**èªªæ˜**ï¼šè§¸ç™¼å¾Œç«¯ç¨‹å¼ï¼Œå°‡æŒ‡å®šé¡Œç›®çš„æ‰€æœ‰å­¸ç”Ÿç¨‹å¼ç¢¼æ‰“åŒ…ä¸¦ä¸Šå‚³è‡³å²ä¸¹ä½› MOSS ä¼ºæœå™¨é€²è¡Œæ¯”å°ã€‚æ­¤éç¨‹ç‚º**éåŒæ­¥åŸ·è¡Œ**ã€‚

**è«‹æ±‚ Body (JSON)**ï¼š

```json
{
    "problem_id": 101,       // (å¿…å¡«) è¦æª¢æ¸¬çš„é¡Œç›® ID
    "language": "python"     // (é¸å¡«) ç¨‹å¼èªè¨€ï¼Œé è¨­ç‚º "python"ã€‚æ”¯æ´: c, cpp, java, python
}
```

**æˆåŠŸå›æ‡‰ (202 Accepted)**ï¼š
ä»£è¡¨ä»»å‹™å·²æ¥æ”¶ä¸¦é–‹å§‹åœ¨èƒŒæ™¯åŸ·è¡Œã€‚

```json
{
    "data": {
        "report_id": 15,
        "status": "pending"
    },
    "message": "å·²é–‹å§‹é€²è¡ŒæŠ„è¥²æ¯”å°ï¼Œè«‹ç¨å¾ŒæŸ¥è©¢çµæœ",
    "status": "ok"
}
```

**å¤±æ•—å›æ‡‰ (400 Bad Request)**ï¼š

  * ç¼ºå°‘ `problem_id`ã€‚
  * (è‹¥å·²å¯¦ä½œ) è©²é¡Œç›®å·²æœ‰æ­£åœ¨é€²è¡Œä¸­çš„ä»»å‹™ã€‚

-----

### 4.2 æŸ¥è©¢æª¢æ¸¬å ±å‘Š (Query)

**è·¯å¾‘**ï¼š`GET /copycat/`
**èªªæ˜**ï¼šæŸ¥è©¢æŒ‡å®šé¡Œç›®çš„**æœ€æ–°**ä¸€ä»½ MOSS æª¢æ¸¬å ±å‘Šçµæœã€‚

**URL åƒæ•¸ (Query Params)**ï¼š

  * `problem_id` (å¿…å¡«)ï¼šé¡Œç›® IDã€‚

**ç¯„ä¾‹**ï¼š`GET /copycat/?problem_id=101`

**æˆåŠŸå›æ‡‰ (200 OK)**ï¼š

  * **æƒ…æ³ Aï¼šè™•ç†ä¸­ (Pending)**

    ```json
    {
        "data": {
            "id": 15,
            "status": "pending",
            "moss_url": null,
            "created_at": "2025-11-28T10:00:00Z",
            "error_message": ""
        },
        "message": "å ±å‘Šç‹€æ…‹ï¼šè™•ç†ä¸­",
        "status": "ok"
    }
    ```

  * **æƒ…æ³ Bï¼šæˆåŠŸ (Success)**
    å‰ç«¯å¯ç›´æ¥ä½¿ç”¨ `moss_url` åœ¨ iframe æˆ–æ–°è¦–çª—ä¸­é¡¯ç¤ºçµæœã€‚

    ```json
    {
        "data": {
            "id": 15,
            "status": "success",
            "moss_url": "http://moss.stanford.edu/results/9/8894923489/",
            "created_at": "2025-11-28T10:05:00Z",
            "error_message": ""
        },
        "message": "æˆåŠŸå–å¾—å ±å‘Š",
        "status": "ok"
    }
    ```

  * **æƒ…æ³ Cï¼šå¤±æ•— (Failed)**
    å¯èƒ½æ˜¯ MOSS ä¼ºæœå™¨é€£ç·šè¶…æ™‚æˆ–ç„¡æ•ˆçš„ç¨‹å¼ç¢¼ã€‚

    ```json
    {
        "data": {
            "id": 15,
            "status": "failed",
            "moss_url": null,
            "created_at": "2025-11-28T10:05:00Z",
            "error_message": "Connection to MOSS server timed out."
        },
        "message": "å ±å‘Šç‹€æ…‹ï¼šå¤±æ•—",
        "status": "error"
    }
    ```

**å¤±æ•—å›æ‡‰ (404 Not Found)**ï¼š

  * è©²é¡Œç›®å¾æœªé€²è¡ŒéæŠ„è¥²æª¢æ¸¬ã€‚
    ```json
    {
        "data": null,
        "message": "æ­¤é¡Œç›®å°šæœªé€²è¡ŒéæŠ„è¥²æ¯”å°",
        "status": "error"
    }
    ```

