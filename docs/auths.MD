# å¾Œç«¯ API èªªæ˜

æœ¬å°ˆæ¡ˆå¾Œç«¯ä½¿ç”¨ **Django + Django REST Framework**ï¼Œæ‰€æœ‰ API æ¡ **JSON** å‚³è¼¸ã€‚

> æœ¬æ–‡ä»¶æ¶µè“‹ã€ŒAPI Tokensã€èˆ‡ã€ŒAuths (æ—¥èªŒ)ã€ç›¸é—œç«¯é»ã€‚

-----

## èªè­‰ (Authentication)

æœ¬å¾Œç«¯ä½¿ç”¨ **Session èªè­‰** (`SessionAuthentication`)ã€‚

é€™æ„å‘³è‘—å‰ç«¯åœ¨å‘¼å« API ä¹‹å‰**å¿…é ˆå…ˆç™»å…¥**ï¼Œä¸¦åœ¨è«‹æ±‚ (Request) ä¸­é™„å¸¶æœ‰æ•ˆçš„ `sessionid` Cookieã€‚

###  é—œæ–¼ CSRF Token

ç”±æ–¼ä½¿ç”¨ `Session` èªè­‰ï¼Œæ‰€æœ‰**æœƒä¿®æ”¹è³‡æ–™**çš„è«‹æ±‚ï¼ˆ`POST`, `PUT`, `DELETE`ï¼‰éƒ½å¿…é ˆé™„å¸¶ `X-CSRFToken` æ¨™é ­ (Header) ä¾†é˜²æ­¢ CSRF æ”»æ“Šã€‚

  * **å‰ç«¯ Web App (åŒç¶²åŸŸ)ï¼š**
    1.  Django æœƒåœ¨ç™»å…¥æ™‚è‡ªå‹•è¨­å®šä¸€å€‹ `csrftoken` cookieã€‚
    2.  å‰ç«¯åœ¨ç™¼é€ `POST` ç­‰è«‹æ±‚æ™‚ï¼Œéœ€è¦**è®€å–é€™å€‹ cookie çš„å€¼**ã€‚
    3.  å°‡é€™å€‹å€¼æ”¾å…¥ HTTP è«‹æ±‚æ¨™é ­ï¼š`X-CSRFToken: "your_csrf_token_value_here"`ã€‚
  * **Postman / cURL æ¸¬è©¦ï¼š**
    1.  ä½ éœ€è¦å…ˆç™»å…¥ (ä¾‹å¦‚ `POST /api-auth/login/` æˆ– `/admin/`) ä»¥å–å¾— `sessionid` å’Œ `csrftoken`ã€‚
    2.  åœ¨ cURL ä¸­ï¼Œä½ éœ€è¦åŒæ™‚é™„å¸¶ `-H "Cookie: sessionid=...; csrftoken=..."` å’Œ `-H "X-CSRFToken: ..."`ã€‚

-----

## 1\. API Tokens API (App: `api_tokens`)

**åŸºç¤è·¯å¾‘**ï¼š`/api-tokens/`

### 1.1 åˆ—å‡º API Tokens

**è·¯å¾‘**ï¼š`GET /api-tokens/`

**èªªæ˜**ï¼šå–å¾—**ç•¶å‰ç™»å…¥ä½¿ç”¨è€…**çš„æ‰€æœ‰ API Tokens çš„å…ƒæ•¸æ“šã€‚

**æ¬Šé™**ï¼šä½¿ç”¨è€…å¿…é ˆç‚ºç™»å…¥ç‹€æ…‹ (Authenticated)ã€‚

**å›æ‡‰æ ¼å¼ (200, JSON)**ï¼š

```json
[
    {
        "id": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
        "name": "æˆ‘çš„ç­†é›» CLI Token",
        "prefix": "ojt_aBcD", 
        "permissions": ["submission:create", "problem:read"],
        "created_at": "2025-10-10T08:00:00Z",
        "expires_at": "2026-10-10T08:00:00Z"
        // ... å…¶ä»–èˆŠæ–‡ä»¶ä¸­æåˆ°çš„æ¬„ä½ (last_used_at ç­‰ï¼Œå–æ±ºæ–¼ä½ çš„ Serializer)
    },
    {
        "id": "f1e2d3c4-b5a6-9876-5432-10fedcba9876",
        "name": "CI/CD å°ˆç”¨ Token",
        "prefix": "ojt_xYzW",
        "permissions": [],
        "created_at": "2025-09-01T00:00:00Z",
        "expires_at": null
    }
]
```

**å¤±æ•—å›æ‡‰ (401/403, JSON)**ï¼š

```json
{
    "detail": "Authentication credentials were not provided."
}
```

-----

### 1.2 å»ºç«‹ API Token

**è·¯å¾‘**ï¼š`POST /api-tokens/`

**èªªæ˜**ï¼šç‚ºç•¶å‰ç™»å…¥çš„ä½¿ç”¨è€…å»ºç«‹ä¸€å€‹æ–°çš„ API Tokenã€‚

**æ¬Šé™**ï¼šä½¿ç”¨è€…å¿…é ˆç‚ºç™»å…¥ç‹€æ…‹ (Authenticated)ã€‚

**è«‹æ±‚æ ¼å¼ (JSON)**ï¼š
| æ¬„ä½å | å‹åˆ¥ | å¿…å¡« | èªªæ˜ |
| --- | --- | :-: | --- |
| `name` | string | âœ… | Token çš„è‡ªè¨‚åç¨±ï¼Œæ–¹ä¾¿ä½¿ç”¨è€…è­˜åˆ¥ã€‚ |
| `permissions` | array (of strings) | âŒ | (ä¿ç•™æ¬„ä½) |
| `expires_at` | string (ISO 8601) | âŒ | éæœŸæ™‚é–“ (ä¾‹å¦‚ `YYYY-MM-DDTHH:MM:SSZ`)ã€‚ |

**è«‹æ±‚ç¯„ä¾‹**ï¼š

```json
{
    "name": "æˆ‘çš„ VS Code é–‹ç™¼å·¥å…·"
}
```

**å›æ‡‰æ ¼å¼ (201, JSON)**ï¼š

**é‡è¦**ï¼š`full_token` åªæœƒåœ¨æ­¤æ¬¡å»ºç«‹æˆåŠŸæ™‚å›å‚³**ä¸€æ¬¡**ï¼Œå‰ç«¯å‹™å¿…æç¤ºä½¿ç”¨è€…å¦¥å–„ä¿å­˜ã€‚

```json
{
    "message": "API Token created...",
    "full_token": "ojt_aBcDeFgHiJkLmNoPqRsTuvWxyZ1234567890abcdef"
}
```

**å¤±æ•—å›æ‡‰ (400, JSON)**ï¼š

```json
{
    "name": [ "This field is required." ]
}
```

-----

### 1.3 åˆªé™¤ API Token

**è·¯å¾‘**ï¼š`DELETE /api-tokens/<uuid:id>/`

**èªªæ˜**ï¼šåˆªé™¤ä¸€å€‹å±¬æ–¼ç•¶å‰ç™»å…¥ä½¿ç”¨è€…çš„æŒ‡å®š API Tokenã€‚

**æ¬Šé™**ï¼šä½¿ç”¨è€…å¿…é ˆç‚ºç™»å…¥ç‹€æ…‹ (Authenticated)ã€‚

**URL åƒæ•¸**ï¼š
| åƒæ•¸ | å‹åˆ¥ | å¿…å¡« | èªªæ˜ |
| --- | --- | :-: | --- |
| `id` | uuid | âœ… | è¦åˆªé™¤çš„ Token çš„ `id` (UUID æ ¼å¼)ã€‚ |

**è«‹æ±‚æ ¼å¼**ï¼š
æ­¤è«‹æ±‚ç„¡éœ€é™„å¸¶ä»»ä½• Bodyã€‚

**å›æ‡‰æ ¼å¼**ï¼š

  * **æˆåŠŸå›æ‡‰ (204 No Content)**ï¼š
    (ä¼ºæœå™¨ä¸è¿”å›ä»»ä½•å…§å®¹ï¼Œä»£è¡¨åˆªé™¤æˆåŠŸ)

  * **å¤±æ•—å›æ‡‰ (404 Not Found)**ï¼š
    (Token ä¸å­˜åœ¨ï¼Œæˆ–ä¸å±¬æ–¼ç›®å‰çš„ä½¿ç”¨è€…)

    ```json
    {
        "detail": "Not found."
    }
    ```

**cURL æ¸¬è©¦ (åŒ…å« CSRF)**ï¼š

```bash
# å‡è¨­ä½ çš„ UUID æ˜¯ a1b2c3d4-e5f6-7890-1234-567890abcdef
curl -X DELETE http://127.0.0.1:8000/api-tokens/a1b2c3d4-e5f6-7890-1234-567890abcdef/ \
  -H "Cookie: sessionid=your_session_id_here; csrftoken=your_csrf_token_here" \
  -H "X-CSRFToken: your_csrf_token_here"
```

-----

-----

## 2\. Auths API (App: `auths`)

**åŸºç¤è·¯å¾‘**ï¼š`/auth/`

### 2.1 åˆ—å‡ºç™»å…¥æ—¥èªŒ

**è·¯å¾‘**ï¼š`GET /auth/login-logs/`

**èªªæ˜**ï¼šå–å¾—ç³»çµ±ä¸­**æ‰€æœ‰ä½¿ç”¨è€…**çš„ç™»å…¥æ—¥èªŒã€‚

**ğŸš¨ æ¬Šé™**ï¼š**åƒ…é™ç®¡ç†å“¡ (Admin)**ã€‚ (`is_staff = True`)

  * ä¸€èˆ¬ä½¿ç”¨è€… (åŒ…å« student) å‘¼å«æ­¤ API æœƒæ”¶åˆ° `403 Forbidden`ã€‚
  * å‰ç«¯åœ¨é–‹ç™¼æ™‚ï¼Œè«‹ç¢ºä¿ä½¿ç”¨**ç®¡ç†å“¡å¸³è™Ÿ**ç™»å…¥æ¸¬è©¦ã€‚

**å›æ‡‰æ ¼å¼ (200, JSON)**ï¼š

```json
[
    {
        "id": 1,
        "user": "blanktsai", // ç™»å…¥æˆåŠŸçš„ User (å¦‚æœå¤±æ•—å‰‡ç‚º null)
        "username": "blanktsai", // å˜—è©¦ç™»å…¥çš„å¸³è™Ÿ
        "login_status": "æˆåŠŸ", // äººé¡å¯è®€çš„ç‹€æ…‹
        "ip_address": "127.0.0.1",
        "user_agent": "Mozilla/5.0 ...",
        "location": null,
        "created_at": "2025-11-08T00:15:00Z"
    },
    {
        "id": 2,
        "user": null,
        "username": "admin_hacker",
        "login_status": "å¯†ç¢¼éŒ¯èª¤", // äººé¡å¯è®€çš„ç‹€æ…‹
        "ip_address": "10.20.30.40",
        "user_agent": "Python/3.11 ...",
        "location": "Taipei",
        "created_at": "2025-11-08T00:10:00Z"
    }
]
```

**å¤±æ•—å›æ‡‰ (403 Forbidden, JSON)**ï¼š

  * ç•¶ç™»å…¥è€…ä¸æ˜¯ç®¡ç†å“¡æ™‚ï¼š
    ```json
    {
        "detail": "You do not have permission to perform this action."
    }
    ```


